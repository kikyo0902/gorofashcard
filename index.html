<!doctype html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Japanese Flashcards</title>
  <style>
    :root{
      --bg:#0b1020;
      --card:#121a33;
      --card2:#0f1730;
      --text:#e9eeff;
      --muted:#a9b4e5;
      --accent:#7c5cff;
      --good:#35d07f;
      --bad:#ff5c7a;
      --line:rgba(255,255,255,.08);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(124,92,255,.35), transparent),
                  radial-gradient(800px 500px at 90% 10%, rgba(53,208,127,.25), transparent),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1080px;margin:0 auto;padding:20px}
    header{
      display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;
      padding:14px 16px;border:1px solid var(--line);border-radius:16px;
      background:rgba(18,26,51,.75);backdrop-filter: blur(10px);
    }
    h1{font-size:18px;margin:0}
    .sub{color:var(--muted);font-size:13px}
    .grid{display:grid;grid-template-columns: 1.1fr .9fr;gap:16px;margin-top:16px}
    @media (max-width: 900px){ .grid{grid-template-columns:1fr} }

    .panel{
      border:1px solid var(--line);border-radius:16px;padding:16px;
      background:rgba(18,26,51,.55);backdrop-filter: blur(10px);
    }
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    button, select, input{
      border-radius:12px;border:1px solid var(--line);
      background:rgba(15,23,48,.8);color:var(--text);
      padding:10px 12px;font-size:14px;outline:none;
    }
    button{cursor:pointer}
    button.primary{background:rgba(124,92,255,.95);border-color:rgba(124,92,255,.6)}
    button.good{background:rgba(53,208,127,.95);border-color:rgba(53,208,127,.6);color:#07130c}
    button.bad{background:rgba(255,92,122,.95);border-color:rgba(255,92,122,.6)}
    button:disabled{opacity:.5;cursor:not-allowed}
    .stat{display:flex;gap:12px;flex-wrap:wrap;margin-top:10px;color:var(--muted);font-size:13px}
    .stat b{color:var(--text)}
    .cardBox{display:flex;flex-direction:column;gap:12px;align-items:center;justify-content:center}
    .card{width:100%;max-width:560px;height:320px;perspective: 1100px}
    .cardInner{
      width:100%;height:100%;
      position:relative;transform-style:preserve-3d;
      transition:transform .6s cubic-bezier(.2,.8,.2,1);
    }
    .card.flip .cardInner{transform:rotateY(180deg)}
    .face{
      position:absolute;inset:0;
      border-radius:18px;border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(18,26,51,.9), rgba(15,23,48,.85));
      display:flex;align-items:center;justify-content:center;
      padding:18px;
      backface-visibility:hidden;
      box-shadow: 0 20px 50px rgba(0,0,0,.35);
    }
    .back{transform:rotateY(180deg);background:linear-gradient(180deg, rgba(18,26,51,.85), rgba(12,18,40,.9))}
    .big{text-align:center;line-height:1.25}
    .jp{font-size:44px;font-weight:700;letter-spacing:.5px}
    .kana{font-size:24px;color:var(--muted);margin-top:10px}
    .vn{font-size:22px;margin-top:10px}
    .tagRow{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:14px}
    .tag{
      font-size:12px;color:var(--muted);border:1px solid var(--line);
      padding:6px 10px;border-radius:999px;background:rgba(0,0,0,.15)
    }
    .hint{color:var(--muted);font-size:13px;text-align:center}
    .formRow{display:grid;grid-template-columns: 1fr 1fr;gap:10px;margin-top:10px}
    .formRow .full{grid-column:1 / -1}
    textarea{
      width:100%;min-height:90px;resize:vertical;
      border-radius:12px;border:1px solid var(--line);
      background:rgba(15,23,48,.8);color:var(--text);
      padding:10px 12px;font-size:14px;outline:none;
    }
    .list{margin-top:12px;max-height:260px;overflow:auto;border-top:1px solid var(--line);padding-top:10px}
    .item{
      display:flex;gap:10px;align-items:flex-start;justify-content:space-between;
      padding:10px;border:1px solid var(--line);border-radius:14px;margin-bottom:8px;
      background:rgba(15,23,48,.55);
    }
    .item small{color:var(--muted)}
    .itemBtns{display:flex;gap:8px;flex-wrap:wrap}
    .rowBetween{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px;
      padding:2px 8px;border-radius:8px;border:1px solid var(--line);color:var(--muted)}
    hr{border:0;border-top:1px solid var(--line);margin:14px 0}

    /* Deck stats table */
    .table{
      width:100%;
      border-collapse:separate;
      border-spacing:0 8px;
      margin-top:12px;
    }
    .table th{
      text-align:left;
      font-size:12px;
      color:var(--muted);
      font-weight:600;
      padding:0 8px;
    }
    .table td{
      background:rgba(15,23,48,.55);
      border:1px solid var(--line);
      padding:10px 10px;
      border-radius:14px;
      vertical-align:middle;
    }
    .pill{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      color:var(--muted);
      font-size:12px;
    }
    .pct{font-weight:800;}
    .rowBtns{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    /* QR box */
    #qrBox canvas, #qrBox img{
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.12);
      padding:8px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1 data-i18n="appTitle">Flash Cards ‚Äî H·ªçc ti·∫øng Nh·∫≠t (Deck/Danh s√°ch)</h1>
        <div class="sub">
          <span data-i18n="headerTip">B·∫•m th·∫ª ƒë·ªÉ l·∫≠t</span>
          ‚Ä¢ <span class="kbd">Space</span> <span data-i18n="kbdFlip">l·∫≠t</span>
          ‚Ä¢ <span class="kbd">‚Üê</span>/<span class="kbd">‚Üí</span> <span data-i18n="kbdNav">chuy·ªÉn th·∫ª</span>
        </div>
      </div>
      <div class="controls">
        <select id="langSelect">
          <option value="vi">Ti·∫øng Vi·ªát</option>
          <option value="ja">Êó•Êú¨Ë™û</option>
        </select>

        <select id="deckFilter"></select>

        <select id="mode">
          <option value="all">T·∫•t c·∫£</option>
          <option value="new">Ch∆∞a nh·ªõ</option>
          <option value="known">ƒê√£ nh·ªõ</option>
        </select>

        <button id="shuffleBtn" data-i18n="shuffle">Ng·∫´u nhi√™n</button>
        <button class="primary" id="resetProgress" data-i18n="resetProgress">Reset ti·∫øn ƒë·ªô</button>
      </div>
    </header>

    <div class="grid">
      <!-- Left -->
      <section class="panel">
        <div class="controls" style="justify-content:space-between">
          <div class="controls">
            <button id="prevBtn" data-i18n="prev">‚Üê Tr∆∞·ªõc</button>
            <button id="nextBtn" data-i18n="next">Sau ‚Üí</button>
            <button id="flipBtn" data-i18n="flip">L·∫≠t</button>
          </div>
          <div class="controls">
            <button class="bad" id="markUnknown" data-i18n="unknown">Ch∆∞a nh·ªõ</button>
            <button class="good" id="markKnown" data-i18n="known">ƒê√£ nh·ªõ</button>
          </div>
        </div>

        <div class="stat" id="stats"></div>

        <div class="cardBox" style="margin-top:14px">
          <div class="card" id="card">
            <div class="cardInner">
              <div class="face front">
                <div class="big">
                  <div class="jp" id="frontText">‚Äî</div>
                  <div class="kana" id="frontSub" data-i18n="tapToFlip">B·∫•m ƒë·ªÉ l·∫≠t</div>
                  <div class="tagRow">
                    <div class="tag" id="tagDeck">üìö Deck: ‚Äî</div>
                    <div class="tag" id="tagCat">#</div>
                    <div class="tag" id="tagLevel">N?</div>
                  </div>
                </div>
              </div>
              <div class="face back">
                <div class="big">
                  <div class="jp" id="backText">‚Äî</div>
                  <div class="kana" id="backKana">‚Äî</div>
                  <div class="vn" id="backVn">‚Äî</div>
                  <div class="hint" id="example" data-i18n="examplePrefix">V√≠ d·ª•: ‚Äî</div>
                </div>
              </div>
            </div>
          </div>
          <div class="hint" data-i18n="rightTip">Tip: T·∫°o deck v√† g√°n t·ª´ v√†o deck ·ªü panel b√™n ph·∫£i ‚Üí</div>
        </div>
      </section>

      <!-- Right -->
      <aside class="panel">
        <div class="rowBetween">
          <div>
            <h2 style="margin:0 0 6px;font-size:16px" data-i18n="deckTitle">Deck (Danh s√°ch)</h2>
            <div class="sub" data-i18n="deckSubtitle">T·∫°o deck ri√™ng: N5, N4, C√¥ng vi·ªác, H·ªôi tho·∫°i‚Ä¶</div>
          </div>
        </div>

        <div class="controls" style="margin-top:8px">
          <input id="newDeckName" data-i18n-placeholder="newDeckPlaceholder" placeholder="T√™n deck m·ªõi (vd: C√¥ng vi·ªác)" />
          <button class="primary" id="createDeckBtn" data-i18n="createDeck">+ T·∫°o deck</button>
          <button class="bad" id="deleteDeckBtn" data-i18n="deleteDeck" title="X√≥a deck ƒëang ch·ªçn (kh√¥ng x√≥a th·∫ª)">X√≥a deck</button>
        </div>

        <!-- Deck management stats -->
        <div style="margin-top:12px">
          <div class="rowBetween">
            <div>
              <h2 style="margin:0;font-size:16px" data-i18n="deckManageTitle">Qu·∫£n l√Ω deck</h2>
              <div class="sub" data-i18n="deckManageSubtitle">Th·ªëng k√™ % ƒë√£ nh·ªõ theo t·ª´ng deck.</div>
            </div>
          </div>
          <div id="deckStatsWrap"></div>
        </div>

        <hr>

        <h2 style="margin:0 0 6px;font-size:16px" data-i18n="addCardTitle">Th√™m Flash Card</h2>
        <div class="sub" data-i18n="addCardSubtitle">Khi th√™m th·∫ª, ch·ªçn deck mu·ªën l∆∞u.</div>

        <div class="formRow">
          <select id="deckSelect" class="full"></select>

          <input id="jp" data-i18n-placeholder="phJp" placeholder="Êó•Êú¨Ë™û (Kanji/Kana) ‚Äî v√≠ d·ª•: ÂãâÂº∑" />
          <input id="kana" data-i18n-placeholder="phKana" placeholder="Kana ‚Äî v√≠ d·ª•: „Åπ„Çì„Åç„Çá„ÅÜ" />
          <input id="vn" class="full" data-i18n-placeholder="phVn" placeholder="Nghƒ©a ti·∫øng Vi·ªát ‚Äî v√≠ d·ª•: h·ªçc t·∫≠p" />
          <input id="cat" data-i18n-placeholder="phCat" placeholder="Ch·ªß ƒë·ªÅ ‚Äî v√≠ d·ª•: c√¥ng vi·ªác" />
          <input id="level" data-i18n-placeholder="phLevel" placeholder="JLPT ‚Äî v√≠ d·ª•: N4" />
          <textarea id="ex" class="full" data-i18n-placeholder="phEx" placeholder="V√≠ d·ª• c√¢u (tu·ª≥ ch·ªçn) ‚Äî v√≠ d·ª•: ÊØéÊó•Êó•Êú¨Ë™û„ÇíÂãâÂº∑„Åó„Åæ„Åô„ÄÇ"></textarea>
        </div>

        <div class="controls" style="margin-top:10px">
          <button class="primary" id="addBtn" data-i18n="addCard">+ Th√™m th·∫ª</button>
          <button id="importBtn" data-i18n="importSample">Import m·∫´u</button>
          <button id="clearAllBtn" data-i18n="clearAll">X√≥a t·∫•t c·∫£</button>
        </div>

        <div class="list" id="list"></div>

        <hr>

        <h2 style="margin:0 0 6px;font-size:16px" data-i18n="qrTitle">QR m·ªü web</h2>
        <div class="sub" data-i18n="qrSubtitle">Qu√©t ƒë·ªÉ m·ªü trang n√†y tr√™n ƒëi·ªán tho·∫°i.</div>
        <div id="qrBox" style="margin-top:10px"></div>
        <button id="regenQR" style="margin-top:10px" data-i18n="qrRegen">T·∫°o l·∫°i QR</button>
      </aside>
    </div>
  </div>

  <!-- QR library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script>
    // ========= Utilities =========
    const $ = (id)=>document.getElementById(id);
    function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }

    function loadJSON(key, fallback){
      const raw = localStorage.getItem(key);
      if(!raw) return fallback;
      try { return JSON.parse(raw); } catch { return fallback; }
    }
    function saveJSON(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

    // ========= Storage Keys =========
    const KEY_CARDS = "jp_flashcards_cards_v3";
    const KEY_PROGRESS = "jp_flashcards_progress_v3";
    const KEY_DECKS = "jp_flashcards_decks_v3";
    const LANG_KEY = "jp_flashcards_lang_v1";

    // ========= i18n =========
    const I18N = {
      vi: {
        appTitle: "Flash Cards ‚Äî H·ªçc ti·∫øng Nh·∫≠t (Deck/Danh s√°ch)",
        headerTip: "B·∫•m th·∫ª ƒë·ªÉ l·∫≠t",
        kbdFlip: "l·∫≠t",
        kbdNav: "chuy·ªÉn th·∫ª",
        shuffle: "Ng·∫´u nhi√™n",
        resetProgress: "Reset ti·∫øn ƒë·ªô",
        prev: "‚Üê Tr∆∞·ªõc",
        next: "Sau ‚Üí",
        flip: "L·∫≠t",
        unknown: "Ch∆∞a nh·ªõ",
        known: "ƒê√£ nh·ªõ",
        tapToFlip: "B·∫•m ƒë·ªÉ l·∫≠t",
        examplePrefix: "V√≠ d·ª•: ",
        rightTip: "Tip: T·∫°o deck v√† g√°n t·ª´ v√†o deck ·ªü panel b√™n ph·∫£i ‚Üí",

        deckTitle: "Deck (Danh s√°ch)",
        deckSubtitle: "T·∫°o deck ri√™ng: N5, N4, C√¥ng vi·ªác, H·ªôi tho·∫°i‚Ä¶",
        createDeck: "+ T·∫°o deck",
        deleteDeck: "X√≥a deck",
        newDeckPlaceholder: "T√™n deck m·ªõi (vd: C√¥ng vi·ªác)",

        deckManageTitle: "Qu·∫£n l√Ω deck",
        deckManageSubtitle: "Th·ªëng k√™ % ƒë√£ nh·ªõ theo t·ª´ng deck.",
        tblDeck: "Deck",
        tblProgress: "Ti·∫øn ƒë·ªô",
        tblPercent: "%",
        tblAction: "H√†nh ƒë·ªông",
        btnStudyDeck: "H·ªçc deck",
        btnRename: "ƒê·ªïi t√™n",
        btnDelete: "X√≥a",
        deckIdLabel: "id",
        progressLabel: "ƒë√£ nh·ªõ / t·ªïng",

        addCardTitle: "Th√™m Flash Card",
        addCardSubtitle: "Khi th√™m th·∫ª, ch·ªçn deck mu·ªën l∆∞u.",
        addCard: "+ Th√™m th·∫ª",
        importSample: "Import m·∫´u",
        clearAll: "X√≥a t·∫•t c·∫£",

        phJp: "Êó•Êú¨Ë™û (Kanji/Kana) ‚Äî v√≠ d·ª•: ÂãâÂº∑",
        phKana: "Kana ‚Äî v√≠ d·ª•: „Åπ„Çì„Åç„Çá„ÅÜ",
        phVn: "Nghƒ©a ti·∫øng Vi·ªát ‚Äî v√≠ d·ª•: h·ªçc t·∫≠p",
        phCat: "Ch·ªß ƒë·ªÅ ‚Äî v√≠ d·ª•: c√¥ng vi·ªác",
        phLevel: "JLPT ‚Äî v√≠ d·ª•: N4",
        phEx: "V√≠ d·ª• c√¢u (tu·ª≥ ch·ªçn) ‚Äî v√≠ d·ª•: ÊØéÊó•Êó•Êú¨Ë™û„ÇíÂãâÂº∑„Åó„Åæ„Åô„ÄÇ",

        modeAll: "T·∫•t c·∫£",
        modeNew: "Ch∆∞a nh·ªõ",
        modeKnown: "ƒê√£ nh·ªõ",

        deckAll: "T·∫•t c·∫£ (All)",
        deckDefault: "M·∫∑c ƒë·ªãnh",

        statsTotal: "T·ªïng th·∫ª",
        statsKnownAll: "ƒê√£ nh·ªõ (t·ªïng)",
        statsShowing: "Hi·ªÉn th·ªã",
        statsKnownShowing: "ƒê√£ nh·ªõ (hi·ªÉn th·ªã)",
        statsPos: "V·ªã tr√≠",

        emptyTitle: "Ch∆∞a c√≥ th·∫ª",
        emptySubtitle: "H√£y th√™m th·∫ª ho·∫∑c Import m·∫´u",

        alertNeedDeckName: "Nh·∫≠p t√™n deck tr∆∞·ªõc nh√©.",
        alertDeckExists: "Deck n√†y ƒë√£ t·ªìn t·∫°i.",
        alertCannotDeleteAll: "Kh√¥ng th·ªÉ x√≥a 'T·∫•t c·∫£ (All)'.",
        alertCannotDeleteDefault: "Kh√¥ng th·ªÉ x√≥a deck 'M·∫∑c ƒë·ªãnh'.",
        confirmDeleteDeck: 'X√≥a deck "{name}"?\n(Th·∫ª trong deck s·∫Ω chuy·ªÉn v·ªÅ "M·∫∑c ƒë·ªãnh")',
        confirmDeleteCard: "X√≥a th·∫ª n√†y?",
        confirmAddSample: "Th√™m b·ªô m·∫´u v√†o danh s√°ch hi·ªán t·∫°i?",
        confirmClearAll: "X√≥a to√†n b·ªô th·∫ª, deck v√† ti·∫øn ƒë·ªô?",
        alertNeedJpVn: "H√£y nh·∫≠p √≠t nh·∫•t: Êó•Êú¨Ë™û v√† Nghƒ©a ti·∫øng Vi·ªát.",
        promptRenameDeck: "T√™n m·ªõi cho deck:",
        alertDeckNameDuplicate: "T√™n deck b·ªã tr√πng.",

        listEmpty: "Ch∆∞a c√≥ d·ªØ li·ªáu. B·∫•m Import m·∫´u ho·∫∑c th√™m th·∫ª m·ªõi.",

        qrTitle: "QR m·ªü web",
        qrSubtitle: "Qu√©t ƒë·ªÉ m·ªü trang n√†y tr√™n ƒëi·ªán tho·∫°i.",
        qrRegen: "T·∫°o l·∫°i QR",
        qrNoUrl: "QR c·∫ßn URL (kh√¥ng ph·∫£i file:///). H√£y up web l√™n GitHub Pages/Netlify ƒë·ªÉ qu√©t m·ªü tr√™n ƒëi·ªán tho·∫°i."
      },
      ja: {
        appTitle: "„Éï„É©„ÉÉ„Ç∑„É•„Ç´„Éº„Éâ ‚Äî Êó•Êú¨Ë™ûÂ≠¶ÁøíÔºà„Éá„ÉÉ„Ç≠ÁÆ°ÁêÜÔºâ",
        headerTip: "„Ç´„Éº„Éâ„Çí„Çø„ÉÉ„Éó„Åó„Å¶Ë£èËøî„Åô",
        kbdFlip: "„ÇÅ„Åè„Çã",
        kbdNav: "„Ç´„Éº„ÉâÁßªÂãï",
        shuffle: "„Ç∑„É£„ÉÉ„Éï„É´",
        resetProgress: "ÈÄ≤Êçó„Çí„É™„Çª„ÉÉ„Éà",
        prev: "‚Üê Ââç„Å∏",
        next: "Ê¨°„Å∏ ‚Üí",
        flip: "„ÇÅ„Åè„Çã",
        unknown: "„Åæ„Å†",
        known: "Ë¶ö„Åà„Åü",
        tapToFlip: "„Çø„ÉÉ„Éó„Åó„Å¶„ÇÅ„Åè„Çã",
        examplePrefix: "‰æãÊñáÔºö",
        rightTip: "TipÔºöÂè≥ÂÅ¥„Åß„Éá„ÉÉ„Ç≠‰ΩúÊàêÔºÜÂçòË™û„Çí„Éá„ÉÉ„Ç≠„Å´ËøΩÂä† ‚Üí",

        deckTitle: "„Éá„ÉÉ„Ç≠Ôºà„É™„Çπ„ÉàÔºâ",
        deckSubtitle: "N5 / N4 / ‰ªï‰∫ã / ‰ºöË©±„Å™„Å©„ÄÅËá™Áî±„Å´„Éá„ÉÉ„Ç≠„Çí‰ΩúÊàê„Åß„Åç„Åæ„Åô„ÄÇ",
        createDeck: "+ „Éá„ÉÉ„Ç≠‰ΩúÊàê",
        deleteDeck: "„Éá„ÉÉ„Ç≠ÂâäÈô§",
        newDeckPlaceholder: "Êñ∞„Åó„ÅÑ„Éá„ÉÉ„Ç≠ÂêçÔºà‰æãÔºö‰ªï‰∫ãÔºâ",

        deckManageTitle: "„Éá„ÉÉ„Ç≠ÁÆ°ÁêÜ",
        deckManageSubtitle: "„Éá„ÉÉ„Ç≠Âà•„ÅÆÁøíÂæóÁéáÔºàÔºÖÔºâ„ÇíË°®Á§∫„Åó„Åæ„Åô„ÄÇ",
        tblDeck: "„Éá„ÉÉ„Ç≠",
        tblProgress: "ÈÄ≤Êçó",
        tblPercent: "%",
        tblAction: "Êìç‰Ωú",
        btnStudyDeck: "„Åì„ÅÆ„Éá„ÉÉ„Ç≠„ÇíÂ≠¶Áøí",
        btnRename: "ÂêçÂâçÂ§âÊõ¥",
        btnDelete: "ÂâäÈô§",
        deckIdLabel: "id",
        progressLabel: "ÁøíÂæó / ÂêàË®à",

        addCardTitle: "„Ç´„Éº„ÉâËøΩÂä†",
        addCardSubtitle: "ËøΩÂä†ÊôÇ„Å´‰øùÂ≠òÂÖà„Éá„ÉÉ„Ç≠„ÇíÈÅ∏Êäû„Åó„Åæ„Åô„ÄÇ",
        addCard: "+ ËøΩÂä†",
        importSample: "„Çµ„É≥„Éó„É´ËøΩÂä†",
        clearAll: "ÂÖ®ÂâäÈô§",

        phJp: "Êó•Êú¨Ë™ûÔºàÊº¢Â≠ó/„Åã„Å™Ôºâ‰æãÔºöÂãâÂº∑",
        phKana: "Ë™≠„ÅøÔºà„Åã„Å™Ôºâ‰æãÔºö„Åπ„Çì„Åç„Çá„ÅÜ",
        phVn: "ÊÑèÂë≥Ôºà„Éô„Éà„Éä„É†Ë™ûÔºâ‰æãÔºöÂ≠¶Áøí",
        phCat: "„Ç´„ÉÜ„Ç¥„É™„Éº ‰æãÔºö‰ªï‰∫ã",
        phLevel: "JLPT ‰æãÔºöN4",
        phEx: "‰æãÊñáÔºà‰ªªÊÑèÔºâ‰æãÔºöÊØéÊó•Êó•Êú¨Ë™û„ÇíÂãâÂº∑„Åó„Åæ„Åô„ÄÇ",

        modeAll: "„Åô„Åπ„Å¶",
        modeNew: "Êú™ÁøíÂæó",
        modeKnown: "ÁøíÂæóÊ∏à„Åø",

        deckAll: "„Åô„Åπ„Å¶ÔºàAllÔºâ",
        deckDefault: "„Éá„Éï„Ç©„É´„Éà",

        statsTotal: "Á∑è„Ç´„Éº„Éâ",
        statsKnownAll: "ÁøíÂæóÔºàÁ∑èÔºâ",
        statsShowing: "Ë°®Á§∫‰∏≠",
        statsKnownShowing: "ÁøíÂæóÔºàË°®Á§∫Ôºâ",
        statsPos: "‰ΩçÁΩÆ",

        emptyTitle: "„Ç´„Éº„Éâ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì",
        emptySubtitle: "„Ç´„Éº„Éâ„ÇíËøΩÂä†„Åô„Çã„Åã„ÄÅ„Çµ„É≥„Éó„É´„ÇíÂÖ•„Çå„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",

        alertNeedDeckName: "„Éá„ÉÉ„Ç≠Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
        alertDeckExists: "„Åù„ÅÆ„Éá„ÉÉ„Ç≠Âêç„ÅØÊó¢„Å´Â≠òÂú®„Åó„Åæ„Åô„ÄÇ",
        alertCannotDeleteAll: "„Äå„Åô„Åπ„Å¶ÔºàAllÔºâ„Äç„ÅØÂâäÈô§„Åß„Åç„Åæ„Åõ„Çì„ÄÇ",
        alertCannotDeleteDefault: "„Äå„Éá„Éï„Ç©„É´„Éà„Äç„ÅØÂâäÈô§„Åß„Åç„Åæ„Åõ„Çì„ÄÇ",
        confirmDeleteDeck: '„Éá„ÉÉ„Ç≠„Äå{name}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\nÔºà„Ç´„Éº„Éâ„ÅØ„Äå„Éá„Éï„Ç©„É´„Éà„Äç„Å´ÁßªÂãï„Åó„Åæ„ÅôÔºâ',
        confirmDeleteCard: "„Åì„ÅÆ„Ç´„Éº„Éâ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü",
        confirmAddSample: "„Çµ„É≥„Éó„É´„ÇíÁèæÂú®„ÅÆ„É™„Çπ„Éà„Å´ËøΩÂä†„Åó„Åæ„Åô„ÅãÔºü",
        confirmClearAll: "„Ç´„Éº„Éâ„Éª„Éá„ÉÉ„Ç≠„ÉªÈÄ≤Êçó„Çí„Åô„Åπ„Å¶ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü",
        alertNeedJpVn: "ÊúÄ‰ΩéÈôê„ÄåÊó•Êú¨Ë™û„Äç„Å®„ÄåÊÑèÂë≥„Äç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
        promptRenameDeck: "Êñ∞„Åó„ÅÑ„Éá„ÉÉ„Ç≠ÂêçÔºö",
        alertDeckNameDuplicate: "„Éá„ÉÉ„Ç≠Âêç„ÅåÈáçË§á„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ",

        listEmpty: "„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ„Äå„Çµ„É≥„Éó„É´ËøΩÂä†„Äç„Åæ„Åü„ÅØÊñ∞Ë¶èËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",

        qrTitle: "QR„ÅßÈñã„Åè",
        qrSubtitle: "„Çπ„Éû„Éõ„ÅßË™≠„ÅøÂèñ„Å£„Å¶Èñã„Åç„Åæ„Åô„ÄÇ",
        qrRegen: "QR„ÇíÂÜçÁîüÊàê",
        qrNoUrl: "QR„ÅØURL„ÅåÂøÖË¶Å„Åß„ÅôÔºàfile:/// „ÅØ‰∏çÂèØÔºâ„ÄÇGitHub Pages / Netlify „Å´ÂÖ¨Èñã„Åô„Çã„Å®„Çπ„Éû„Éõ„ÅßÈñã„Åë„Åæ„Åô„ÄÇ"
      }
    };

    let currentLang = localStorage.getItem(LANG_KEY) || "vi";
    function t(key){
      return (I18N[currentLang] && I18N[currentLang][key]) || key;
    }
    function applyI18n(){
      // text nodes
      document.querySelectorAll("[data-i18n]").forEach(el=>{
        const key = el.getAttribute("data-i18n");
        el.textContent = t(key);
      });
      // placeholders
      document.querySelectorAll("[data-i18n-placeholder]").forEach(el=>{
        const key = el.getAttribute("data-i18n-placeholder");
        el.setAttribute("placeholder", t(key));
      });
      // mode options
      const modeEl = $("mode");
      if(modeEl){
        modeEl.querySelectorAll("option").forEach(opt=>{
          if(opt.value==="all") opt.textContent = t("modeAll");
          if(opt.value==="new") opt.textContent = t("modeNew");
          if(opt.value==="known") opt.textContent = t("modeKnown");
        });
      }
      // update dynamic areas
      renderDeckOptions();
      renderDeckStats();
      renderStats();
      renderCard();
      renderList();
      renderQR();
    }

    // ========= Default data =========
    let decks = loadJSON(KEY_DECKS, null);
    if(!decks){
      decks = [
        { id:"all", name:"T·∫•t c·∫£ (All)" },
        { id:"default", name:"M·∫∑c ƒë·ªãnh" },
        { id:"work", name:"C√¥ng vi·ªác" },
        { id:"daily", name:"Giao ti·∫øp" },
      ];
      saveJSON(KEY_DECKS, decks);
    } else {
      if(!decks.find(d=>d.id==="all")){
        decks.unshift({id:"all", name:"T·∫•t c·∫£ (All)"});
        saveJSON(KEY_DECKS, decks);
      }
      if(!decks.find(d=>d.id==="default")){
        decks.push({id:"default", name:"M·∫∑c ƒë·ªãnh"});
        saveJSON(KEY_DECKS, decks);
      }
    }

    let cards = loadJSON(KEY_CARDS, []);
    let progress = loadJSON(KEY_PROGRESS, {}); // { [cardId]: true/false }

    const sampleCards = [
      { jp:"ÂãâÂº∑", kana:"„Åπ„Çì„Åç„Çá„ÅÜ", vn:"h·ªçc t·∫≠p", ex:"ÊØéÊó•Êó•Êú¨Ë™û„ÇíÂãâÂº∑„Åó„Åæ„Åô„ÄÇ", cat:"h·ªçc t·∫≠p", level:"N5", deckId:"default" },
      { jp:"Á¥ÑÊùü", kana:"„ÇÑ„Åè„Åù„Åè", vn:"l·ªùi h·ª©a / h·∫πn", ex:"ÊòéÊó•„ÄÅÈßÖ„Åß‰ºö„ÅÜÁ¥ÑÊùü„Åß„Åô„ÄÇ", cat:"ƒë·ªùi s·ªëng", level:"N4", deckId:"daily" },
      { jp:"Á¢∫Ë™ç", kana:"„Åã„Åè„Å´„Çì", vn:"x√°c nh·∫≠n", ex:"„ÇÇ„ÅÜ‰∏ÄÂ∫¶Á¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ", cat:"c√¥ng vi·ªác", level:"N3", deckId:"work" },
      { jp:"Â§ß‰∏àÂ§´", kana:"„Å†„ÅÑ„Åò„Çá„ÅÜ„Å∂", vn:"·ªïn m√† / kh√¥ng sao", ex:"Â§ß‰∏àÂ§´Ôºü„ÅÜ„Çì„ÄÅÂ§ß‰∏àÂ§´„ÄÇ", cat:"giao ti·∫øp", level:"N5", deckId:"daily" },
    ];

    // ========= DOM =========
    const cardEl = $("card");
    const frontText = $("frontText");
    const backText  = $("backText");
    const backKana  = $("backKana");
    const backVn    = $("backVn");
    const example   = $("example");
    const tagDeck   = $("tagDeck");
    const tagCat    = $("tagCat");
    const tagLevel  = $("tagLevel");
    const stats     = $("stats");
    const listEl    = $("list");
    const modeEl    = $("mode");
    const deckFilterEl = $("deckFilter");
    const deckSelectEl = $("deckSelect");
    const deckStatsWrap = $("deckStatsWrap");

    let filtered = [];
    let idx = 0;
    let isFlip = false;

    // ========= Helpers =========
    function deckNameById(id){
      return (decks.find(d=>d.id===id)?.name) || t("deckDefault");
    }

    function normalizeSystemDeckNames(){
      // keep user-created names, only translate system deck labels
      const dAll = decks.find(d=>d.id==="all");
      const dDef = decks.find(d=>d.id==="default");
      if(dAll) dAll.name = t("deckAll");
      if(dDef) dDef.name = t("deckDefault");
      saveJSON(KEY_DECKS, decks);
    }

    function renderDeckOptions(){
      normalizeSystemDeckNames();

      // deckFilter: include all
      deckFilterEl.innerHTML = "";
      decks.forEach(d=>{
        const opt = document.createElement("option");
        opt.value = d.id;
        opt.textContent = d.name;
        deckFilterEl.appendChild(opt);
      });

      // deckSelect: exclude all
      deckSelectEl.innerHTML = "";
      decks.filter(d=>d.id!=="all").forEach(d=>{
        const opt = document.createElement("option");
        opt.value = d.id;
        opt.textContent = d.name;
        deckSelectEl.appendChild(opt);
      });

      if(!deckFilterEl.value) deckFilterEl.value = "all";
      if(!deckSelectEl.value) deckSelectEl.value = "default";
    }

    function applyFilter(){
      const mode = modeEl.value;
      const deckId = deckFilterEl.value;

      let arr = cards.slice();

      if(deckId !== "all"){
        arr = arr.filter(c => (c.deckId || "default") === deckId);
      }

      if(mode === "new"){
        arr = arr.filter(c => progress[c.id] !== true);
      } else if(mode === "known"){
        arr = arr.filter(c => progress[c.id] === true);
      }

      filtered = arr;

      if(filtered.length === 0){
        idx = 0;
        renderEmpty();
        renderStats();
        renderList();
        renderDeckStats();
        return;
      }

      idx = Math.min(idx, filtered.length - 1);
      isFlip = false;
      cardEl.classList.remove("flip");
      renderCard();
      renderStats();
      renderList();
      renderDeckStats();
    }

    function renderEmpty(){
      frontText.textContent = t("emptyTitle");
      $("frontSub").textContent = t("emptySubtitle");

      backText.textContent = "‚Äî";
      backKana.textContent = "‚Äî";
      backVn.textContent = "‚Äî";
      example.textContent = t("examplePrefix") + "‚Äî";

      tagDeck.textContent = "üìö Deck: ‚Äî";
      tagCat.textContent = "#";
      tagLevel.textContent = "N?";
    }

    function renderCard(){
      if(filtered.length === 0) return;
      const c = filtered[idx];
      const known = progress[c.id] === true;

      frontText.textContent = c.jp || "‚Äî";
      $("frontSub").textContent = known ? "‚úÖ " + t("known") : "üü° " + t("unknown");

      backText.textContent = c.jp || "‚Äî";
      backKana.textContent = c.kana ? `(${c.kana})` : "‚Äî";
      backVn.textContent = c.vn || "‚Äî";
      example.textContent = t("examplePrefix") + (c.ex || "‚Äî");

      tagDeck.textContent = "üìö Deck: " + deckNameById(c.deckId || "default");
      tagCat.textContent = "#" + (c.cat || "kh√°c");
      tagLevel.textContent = (c.level || "N?");
    }

    function renderStats(){
      const total = cards.length;
      const knownAll = Object.values(progress).filter(v=>v===true).length;
      const showing = filtered.length;
      const knownShowing = filtered.filter(c=>progress[c.id]===true).length;

      stats.innerHTML = `
        <div>${t("statsTotal")}: <b>${total}</b></div>
        <div>${t("statsKnownAll")}: <b>${knownAll}</b></div>
        <div>${t("statsShowing")}: <b>${showing}</b></div>
        <div>${t("statsKnownShowing")}: <b>${knownShowing}</b></div>
        <div>${t("statsPos")}: <b>${showing ? (idx+1) : 0}/${showing}</b></div>
      `;
    }

    function renderList(){
      listEl.innerHTML = "";
      if(cards.length === 0){
        listEl.innerHTML = `<div class="hint">${t("listEmpty")}</div>`;
        return;
      }

      const deckId = deckFilterEl.value;
      const listCards = (deckId==="all") ? cards : cards.filter(c=>(c.deckId||"default")===deckId);

      listCards.forEach((c)=>{
        const div = document.createElement("div");
        div.className = "item";
        const known = progress[c.id] === true;

        div.innerHTML = `
          <div>
            <div style="font-weight:700">${c.jp || "‚Äî"} <small>${c.kana ? "("+c.kana+")" : ""}</small></div>
            <div class="sub">${c.vn || ""}</div>
            <div class="sub">üìö ${deckNameById(c.deckId || "default")}${(c.cat? " ‚Ä¢ #"+c.cat : "")}${c.level ? " ‚Ä¢ "+c.level : ""}${known ? " ‚Ä¢ ‚úÖ "+t("known") : ""}</div>
          </div>
          <div class="itemBtns">
            <button data-go="${c.id}">${currentLang==="ja" ? "Â≠¶Áøí" : "H·ªçc"}</button>
            <button data-del="${c.id}" class="bad">${t("btnDelete") || (currentLang==="ja" ? "ÂâäÈô§" : "X√≥a")}</button>
          </div>
        `;
        listEl.appendChild(div);
      });

      listEl.querySelectorAll("button[data-go]").forEach(btn=>{
        btn.onclick = ()=>{
          const id = btn.dataset.go;
          const pos = filtered.findIndex(x=>x.id===id);
          if(pos >= 0){
            idx = pos;
            isFlip = false;
            cardEl.classList.remove("flip");
            renderCard(); renderStats();
          } else {
            modeEl.value = "all";
            applyFilter();
            const pos2 = filtered.findIndex(x=>x.id===id);
            if(pos2 >= 0){
              idx = pos2;
              renderCard(); renderStats();
            }
          }
        };
      });

      listEl.querySelectorAll("button[data-del]").forEach(btn=>{
        btn.onclick = ()=>{
          const id = btn.dataset.del;
          if(!confirm(t("confirmDeleteCard"))) return;
          cards = cards.filter(c=>c.id!==id);
          delete progress[id];
          saveJSON(KEY_CARDS, cards);
          saveJSON(KEY_PROGRESS, progress);
          applyFilter();
        };
      });
    }

    // ========= Deck stats =========
    function getDeckStats(){
      const realDecks = decks.filter(d=>d.id!=="all");
      const stats = realDecks.map(d=>{
        const deckCards = cards.filter(c=>(c.deckId||"default")===d.id);
        const total = deckCards.length;
        const known = deckCards.filter(c=>progress[c.id]===true).length;
        const pct = total ? Math.round((known/total)*100) : 0;
        return { id:d.id, name:d.name, total, known, pct };
      });
      stats.sort((a,b)=> (b.pct-a.pct) || (b.total-a.total));
      return stats;
    }

    function renderDeckStats(){
      if(!deckStatsWrap) return;

      const s = getDeckStats();
      if(s.length === 0){
        deckStatsWrap.innerHTML = `<div class="hint">‚Äî</div>`;
        return;
      }

      const rows = s.map(x=>{
        const lock = (x.id==="default");
        return `
          <tr>
            <td style="width:34%">
              <div style="font-weight:800">${x.name}</div>
              <div class="sub"><span class="pill">${t("deckIdLabel")}: ${x.id}</span></div>
            </td>
            <td style="width:22%">
              <div><b>${x.known}</b> / <b>${x.total}</b></div>
              <div class="sub">${t("progressLabel")}</div>
            </td>
            <td style="width:14%">
              <div class="pct">${x.pct}%</div>
            </td>
            <td style="width:30%">
              <div class="rowBtns">
                <button data-studydeck="${x.id}">${t("btnStudyDeck")}</button>
                <button data-renamedeck="${x.id}">${t("btnRename")}</button>
                <button data-deletedeck="${x.id}" class="bad" ${lock ? "disabled" : ""}>${t("btnDelete")}</button>
              </div>
            </td>
          </tr>
        `;
      }).join("");

      deckStatsWrap.innerHTML = `
        <table class="table">
          <thead>
            <tr>
              <th>${t("tblDeck")}</th>
              <th>${t("tblProgress")}</th>
              <th>${t("tblPercent")}</th>
              <th style="text-align:right">${t("tblAction")}</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;

      deckStatsWrap.querySelectorAll("button[data-studydeck]").forEach(btn=>{
        btn.onclick = ()=>{
          const id = btn.dataset.studydeck;
          deckFilterEl.value = id;
          modeEl.value = "all";
          applyFilter();
          window.scrollTo({top:0, behavior:"smooth"});
        };
      });

      deckStatsWrap.querySelectorAll("button[data-renamedeck]").forEach(btn=>{
        btn.onclick = ()=>{
          const id = btn.dataset.renamedeck;
          if(id==="all") return;
          const old = deckNameById(id);
          const name = prompt(t("promptRenameDeck"), old);
          if(!name) return;

          if(decks.some(d=>d.name.toLowerCase()===name.trim().toLowerCase() && d.id!==id)){
            alert(t("alertDeckNameDuplicate"));
            return;
          }

          decks = decks.map(d=> d.id===id ? {...d, name:name.trim()} : d);
          saveJSON(KEY_DECKS, decks);
          renderDeckOptions();
          applyFilter();
        };
      });

      deckStatsWrap.querySelectorAll("button[data-deletedeck]").forEach(btn=>{
        btn.onclick = ()=>{
          const id = btn.dataset.deletedeck;
          if(id==="default") return;

          const name = deckNameById(id);
          if(!confirm(t("confirmDeleteDeck").replace("{name}", name))) return;

          cards = cards.map(c => (c.deckId===id ? {...c, deckId:"default"} : c));
          decks = decks.filter(d=>d.id!==id);

          saveJSON(KEY_CARDS, cards);
          saveJSON(KEY_DECKS, decks);

          renderDeckOptions();
          deckFilterEl.value = "all";
          applyFilter();
        };
      });
    }

    // ========= Navigation / actions =========
    function next(){
      if(filtered.length === 0) return;
      idx = (idx + 1) % filtered.length;
      isFlip = false;
      cardEl.classList.remove("flip");
      renderCard(); renderStats();
    }
    function prev(){
      if(filtered.length === 0) return;
      idx = (idx - 1 + filtered.length) % filtered.length;
      isFlip = false;
      cardEl.classList.remove("flip");
      renderCard(); renderStats();
    }
    function flip(){
      if(filtered.length === 0) return;
      isFlip = !isFlip;
      cardEl.classList.toggle("flip", isFlip);
    }
    function markKnown(val){
      if(filtered.length === 0) return;
      const c = filtered[idx];
      progress[c.id] = val;
      saveJSON(KEY_PROGRESS, progress);
      renderCard(); renderStats(); renderList(); renderDeckStats();
      if(modeEl.value !== "all") applyFilter();
    }

    // ========= QR =========
    function renderQR(){
      const qrBox = $("qrBox");
      if(!qrBox) return;
      qrBox.innerHTML = "";

      const url = window.location.href;

      // file:/// -> QR qu√©t th∆∞·ªùng kh√¥ng m·ªü ƒë∆∞·ª£c tr√™n mobile
      if(url.startsWith("file:")){
        const div = document.createElement("div");
        div.className = "hint";
        div.textContent = t("qrNoUrl");
        qrBox.appendChild(div);
        return;
      }

      try{
        new QRCode(qrBox, {
          text: url,
          width: 180,
          height: 180,
          correctLevel: QRCode.CorrectLevel.M
        });
      }catch(e){
        const div = document.createElement("div");
        div.className = "hint";
        div.textContent = "QR error";
        qrBox.appendChild(div);
      }
    }

    // ========= Events =========
    $("nextBtn").onclick = next;
    $("prevBtn").onclick = prev;
    $("flipBtn").onclick = flip;
    cardEl.onclick = flip;

    $("markKnown").onclick = ()=>markKnown(true);
    $("markUnknown").onclick = ()=>markKnown(false);

    $("shuffleBtn").onclick = ()=>{
      for(let i=filtered.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [filtered[i], filtered[j]] = [filtered[j], filtered[i]];
      }
      idx = 0;
      isFlip = false;
      cardEl.classList.remove("flip");
      renderCard(); renderStats();
    };

    $("resetProgress").onclick = ()=>{
      progress = {};
      saveJSON(KEY_PROGRESS, progress);
      applyFilter();
    };

    $("createDeckBtn").onclick = ()=>{
      const name = $("newDeckName").value.trim();
      if(!name){ alert(t("alertNeedDeckName")); return; }
      if(decks.some(d=>d.name.toLowerCase()===name.toLowerCase())){
        alert(t("alertDeckExists"));
        return;
      }
      const id = uid();
      decks.push({id, name});
      saveJSON(KEY_DECKS, decks);

      $("newDeckName").value = "";
      renderDeckOptions();
      deckFilterEl.value = id;
      deckSelectEl.value = id;
      applyFilter();
    };

    $("deleteDeckBtn").onclick = ()=>{
      const id = deckFilterEl.value;
      if(id === "all"){ alert(t("alertCannotDeleteAll")); return; }
      if(id === "default"){ alert(t("alertCannotDeleteDefault")); return; }

      const name = deckNameById(id);
      if(!confirm(t("confirmDeleteDeck").replace("{name}", name))) return;

      cards = cards.map(c => (c.deckId===id ? {...c, deckId:"default"} : c));
      decks = decks.filter(d=>d.id!==id);

      saveJSON(KEY_CARDS, cards);
      saveJSON(KEY_DECKS, decks);

      renderDeckOptions();
      deckFilterEl.value = "all";
      applyFilter();
    };

    $("addBtn").onclick = ()=>{
      const c = {
        id: uid(),
        deckId: deckSelectEl.value || "default",
        jp: $("jp").value.trim(),
        kana: $("kana").value.trim(),
        vn: $("vn").value.trim(),
        ex: $("ex").value.trim(),
        cat: $("cat").value.trim(),
        level: $("level").value.trim(),
      };
      if(!c.jp || !c.vn){
        alert(t("alertNeedJpVn"));
        return;
      }
      cards.unshift(c);
      saveJSON(KEY_CARDS, cards);

      ["jp","kana","vn","ex","cat","level"].forEach(id=>$(id).value="");
      applyFilter();
    };

    $("importBtn").onclick = ()=>{
      if(cards.length && !confirm(t("confirmAddSample"))) return;
      const samples = sampleCards.map(x => ({...x, id: uid()}));
      cards = [...samples, ...cards];
      saveJSON(KEY_CARDS, cards);
      applyFilter();
    };

    $("clearAllBtn").onclick = ()=>{
      if(!confirm(t("confirmClearAll"))) return;

      cards = [];
      progress = {};
      decks = [{ id:"all", name:t("deckAll") }, { id:"default", name:t("deckDefault") }];

      localStorage.removeItem(KEY_CARDS);
      localStorage.removeItem(KEY_PROGRESS);
      saveJSON(KEY_DECKS, decks);

      renderDeckOptions();
      applyFilter();
    };

    $("regenQR").onclick = renderQR;

    modeEl.onchange = applyFilter;
    deckFilterEl.onchange = applyFilter;

    // Keyboard
    window.addEventListener("keydown", (e)=>{
      if(e.key === "ArrowRight") next();
      if(e.key === "ArrowLeft") prev();
      if(e.key === " "){ e.preventDefault(); flip(); }
      if(e.key.toLowerCase() === "k") markKnown(true);
      if(e.key.toLowerCase() === "u") markKnown(false);
    });

    // Language select
    const langSelect = $("langSelect");
    langSelect.value = currentLang;
    langSelect.addEventListener("change", ()=>{
      currentLang = langSelect.value;
      localStorage.setItem(LANG_KEY, currentLang);
      applyI18n();
    });

    // ========= Init =========
    renderDeckOptions();
    applyFilter(); // this calls renderDeckStats too
    renderQR();
    applyI18n(); // apply i18n last so labels update
  </script>
</body>
</html>    button, select, input{
      border-radius:12px;border:1px solid var(--line);
      background:rgba(15,23,48,.8);color:var(--text);
      padding:10px 12px;font-size:14px;outline:none;
    }
    button{cursor:pointer}
    button.primary{background:rgba(124,92,255,.95);border-color:rgba(124,92,255,.6)}
    button.good{background:rgba(53,208,127,.95);border-color:rgba(53,208,127,.6);color:#07130c}
    button.bad{background:rgba(255,92,122,.95);border-color:rgba(255,92,122,.6)}
    button:disabled{opacity:.5;cursor:not-allowed}
    .stat{display:flex;gap:12px;flex-wrap:wrap;margin-top:10px;color:var(--muted);font-size:13px}
    .stat b{color:var(--text)}
    .cardBox{display:flex;flex-direction:column;gap:12px;align-items:center;justify-content:center}
    .card{width:100%;max-width:560px;height:320px;perspective: 1100px}
    .cardInner{
      width:100%;height:100%;
      position:relative;transform-style:preserve-3d;
      transition:transform .6s cubic-bezier(.2,.8,.2,1);
    }
    .card.flip .cardInner{transform:rotateY(180deg)}
    .face{
      position:absolute;inset:0;
      border-radius:18px;border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(18,26,51,.9), rgba(15,23,48,.85));
      display:flex;align-items:center;justify-content:center;
      padding:18px;
      backface-visibility:hidden;
      box-shadow: 0 20px 50px rgba(0,0,0,.35);
    }
    .back{transform:rotateY(180deg);background:linear-gradient(180deg, rgba(18,26,51,.85), rgba(12,18,40,.9))}
    .big{text-align:center;line-height:1.25}
    .jp{font-size:44px;font-weight:700;letter-spacing:.5px}
    .kana{font-size:24px;color:var(--muted);margin-top:10px}
    .vn{font-size:22px;margin-top:10px}
    .tagRow{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:14px}
    .tag{
      font-size:12px;color:var(--muted);border:1px solid var(--line);
      padding:6px 10px;border-radius:999px;background:rgba(0,0,0,.15)
    }
    .hint{color:var(--muted);font-size:13px;text-align:center}
    .formRow{display:grid;grid-template-columns: 1fr 1fr;gap:10px;margin-top:10px}
    .formRow .full{grid-column:1 / -1}
    textarea{
      width:100%;min-height:90px;resize:vertical;
      border-radius:12px;border:1px solid var(--line);
      background:rgba(15,23,48,.8);color:var(--text);
      padding:10px 12px;font-size:14px;outline:none;
    }
    .list{margin-top:12px;max-height:260px;overflow:auto;border-top:1px solid var(--line);padding-top:10px}
    .item{
      display:flex;gap:10px;align-items:flex-start;justify-content:space-between;
      padding:10px;border:1px solid var(--line);border-radius:14px;margin-bottom:8px;
      background:rgba(15,23,48,.55);
    }
    .item small{color:var(--muted)}
    .itemBtns{display:flex;gap:8px;flex-wrap:wrap}
    .rowBetween{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px;
      padding:2px 8px;border-radius:8px;border:1px solid var(--line);color:var(--muted)}
      .table{
  width:100%;
  border-collapse:separate;
  border-spacing:0 8px;
  margin-top:12px;
}
.table th{
  text-align:left;
  font-size:12px;
  color:var(--muted);
  font-weight:600;
  padding:0 8px;
}
.table td{
  background:rgba(15,23,48,.55);
  border:1px solid var(--line);
  padding:10px 10px;
  border-radius:14px;
  vertical-align:middle;
}
.pill{
  display:inline-block;
  padding:4px 10px;
  border-radius:999px;
  border:1px solid var(--line);
  color:var(--muted);
  font-size:12px;
}
.pct{
  font-weight:800;
}
.rowBtns{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  justify-content:flex-end;
}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Flash Cards ‚Äî H·ªçc ti·∫øng Nh·∫≠t (Deck/Danh s√°ch)</h1>
        <div class="sub">B·∫•m th·∫ª ƒë·ªÉ l·∫≠t ‚Ä¢ <span class="kbd">Space</span> l·∫≠t ‚Ä¢ <span class="kbd">‚Üê</span>/<span class="kbd">‚Üí</span> chuy·ªÉn th·∫ª</div>
      </div>
      <div class="controls">
        <select id="deckFilter"></select>
        <select id="mode">
          <option value="all">T·∫•t c·∫£</option>
          <option value="new">Ch∆∞a nh·ªõ</option>
          <option value="known">ƒê√£ nh·ªõ</option>
        </select>
        <button id="shuffleBtn">Ng·∫´u nhi√™n</button>
        <button class="primary" id="resetProgress">Reset ti·∫øn ƒë·ªô</button>
      </div>
    </header>

    <div class="grid">
      <!-- Left -->
      <section class="panel">
        <div class="controls" style="justify-content:space-between">
          <div class="controls">
            <button id="prevBtn">‚Üê Tr∆∞·ªõc</button>
            <button id="nextBtn">Sau ‚Üí</button>
            <button id="flipBtn">L·∫≠t</button>
          </div>
          <div class="controls">
            <button class="bad" id="markUnknown">Ch∆∞a nh·ªõ</button>
            <button class="good" id="markKnown">ƒê√£ nh·ªõ</button>
          </div>
        </div>

        <div class="stat" id="stats"></div>

        <div class="cardBox" style="margin-top:14px">
          <div class="card" id="card">
            <div class="cardInner">
              <div class="face front">
                <div class="big">
                  <div class="jp" id="frontText">‚Äî</div>
                  <div class="kana" id="frontSub">B·∫•m ƒë·ªÉ l·∫≠t</div>
                  <div class="tagRow">
                    <div class="tag" id="tagDeck">üìö Deck: ‚Äî</div>
                    <div class="tag" id="tagCat">#</div>
                    <div class="tag" id="tagLevel">N?</div>
                  </div>
                </div>
              </div>
              <div class="face back">
                <div class="big">
                  <div class="jp" id="backText">‚Äî</div>
                  <div class="kana" id="backKana">‚Äî</div>
                  <div class="vn" id="backVn">‚Äî</div>
                  <div class="hint" id="example">V√≠ d·ª•: ‚Äî</div>
                </div>
              </div>
            </div>
          </div>
          <div class="hint">Tip: Th√™m deck/danh s√°ch v√† g√°n t·ª´ v√†o deck ·ªü panel b√™n ph·∫£i ‚Üí</div>
        </div>
      </section>

      <!-- Right -->
      <aside class="panel">
        <div class="rowBetween">
          <div>
            <h2 style="margin:0 0 6px;font-size:16px">Deck (Danh s√°ch)</h2>
            <div class="sub">T·∫°o deck ri√™ng: N5, N4, C√¥ng vi·ªác, H·ªôi tho·∫°i‚Ä¶</div>
          </div>
        </div>

        <div class="controls" style="margin-top:8px">
          <input id="newDeckName" placeholder="T√™n deck m·ªõi (vd: C√¥ng vi·ªác)" />
          <button class="primary" id="createDeckBtn">+ T·∫°o deck</button>
          <button class="bad" id="deleteDeckBtn" title="X√≥a deck ƒëang ch·ªçn (kh√¥ng x√≥a th·∫ª)">X√≥a deck</button>
        </div>
        <div style="margin-top:12px">
  <div class="rowBetween">
    <div>
      <h2 style="margin:0;font-size:16px">Qu·∫£n l√Ω deck</h2>
      <div class="sub">Th·ªëng k√™ % ƒë√£ nh·ªõ theo t·ª´ng deck.</div>
    </div>
  </div>

  <div id="deckStatsWrap"></div>
</div>
        <hr style="border:0;border-top:1px solid var(--line);margin:14px 0">

        <h2 style="margin:0 0 6px;font-size:16px">Th√™m Flash Card</h2>
        <div class="sub">Khi th√™m th·∫ª, ch·ªçn deck mu·ªën l∆∞u.</div>

        <div class="formRow">
          <select id="deckSelect" class="full"></select>

          <input id="jp" placeholder="Êó•Êú¨Ë™û (Kanji/Kana) ‚Äî v√≠ d·ª•: ÂãâÂº∑" />
          <input id="kana" placeholder="Kana ‚Äî v√≠ d·ª•: „Åπ„Çì„Åç„Çá„ÅÜ" />
          <input id="vn" class="full" placeholder="Nghƒ©a ti·∫øng Vi·ªát ‚Äî v√≠ d·ª•: h·ªçc t·∫≠p" />
          <input id="cat" placeholder="Ch·ªß ƒë·ªÅ ‚Äî v√≠ d·ª•: c√¥ng vi·ªác" />
          <input id="level" placeholder="JLPT ‚Äî v√≠ d·ª•: N4" />
          <textarea id="ex" class="full" placeholder="V√≠ d·ª• c√¢u (tu·ª≥ ch·ªçn) ‚Äî v√≠ d·ª•: ÊØéÊó•Êó•Êú¨Ë™û„ÇíÂãâÂº∑„Åó„Åæ„Åô„ÄÇ"></textarea>
        </div>

        <div class="controls" style="margin-top:10px">
          <button class="primary" id="addBtn">+ Th√™m th·∫ª</button>
          <button id="importBtn">Import m·∫´u</button>
          <button id="clearAllBtn">X√≥a t·∫•t c·∫£</button>
        </div>

        <div class="list" id="list"></div>
      </aside>
    </div>
  </div>

  <script>
    // ========= Storage =========
    const KEY_CARDS = "jp_flashcards_cards_v2";
    const KEY_PROGRESS = "jp_flashcards_progress_v2";
    const KEY_DECKS = "jp_flashcards_decks_v2";

    // cards: [{jp,kana,vn,ex,cat,level,deckId}]
    // decks: [{id,name}]
    function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }

    function loadJSON(key, fallback){
      const raw = localStorage.getItem(key);
      if(!raw) return fallback;
      try { return JSON.parse(raw); } catch { return fallback; }
    }
    function saveJSON(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

    // ========= Default =========
    const defaultDecks = [
      { id:"all", name:"T·∫•t c·∫£ (All)" },
      { id:"default", name:"M·∫∑c ƒë·ªãnh" },
      { id:"work", name:"C√¥ng vi·ªác" },
      { id:"daily", name:"Giao ti·∫øp" },
    ];

    const defaultCards = [
      { jp:"ÂãâÂº∑", kana:"„Åπ„Çì„Åç„Çá„ÅÜ", vn:"h·ªçc t·∫≠p", ex:"ÊØéÊó•Êó•Êú¨Ë™û„ÇíÂãâÂº∑„Åó„Åæ„Åô„ÄÇ", cat:"h·ªçc t·∫≠p", level:"N5", deckId:"default" },
      { jp:"Á¥ÑÊùü", kana:"„ÇÑ„Åè„Åù„Åè", vn:"l·ªùi h·ª©a / h·∫πn", ex:"ÊòéÊó•„ÄÅÈßÖ„Åß‰ºö„ÅÜÁ¥ÑÊùü„Åß„Åô„ÄÇ", cat:"ƒë·ªùi s·ªëng", level:"N4", deckId:"daily" },
      { jp:"Á¢∫Ë™ç", kana:"„Åã„Åè„Å´„Çì", vn:"x√°c nh·∫≠n", ex:"„ÇÇ„ÅÜ‰∏ÄÂ∫¶Á¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ", cat:"c√¥ng vi·ªác", level:"N3", deckId:"work" },
      { jp:"Â§ß‰∏àÂ§´", kana:"„Å†„ÅÑ„Åò„Çá„ÅÜ„Å∂", vn:"·ªïn m√† / kh√¥ng sao", ex:"Â§ß‰∏àÂ§´Ôºü„ÅÜ„Çì„ÄÅÂ§ß‰∏àÂ§´„ÄÇ", cat:"giao ti·∫øp", level:"N5", deckId:"daily" },
    ];

    // ========= State =========
    let decks = loadJSON(KEY_DECKS, null);
    if(!decks){
      decks = defaultDecks.slice();
      saveJSON(KEY_DECKS, decks);
    } else {
      // ƒë·∫£m b·∫£o c√≥ deck "all"
      if(!decks.find(d=>d.id==="all")){
        decks.unshift({id:"all", name:"T·∫•t c·∫£ (All)"});
        saveJSON(KEY_DECKS, decks);
      }
    }

    let cards = loadJSON(KEY_CARDS, []);
    let progress = loadJSON(KEY_PROGRESS, {}); // { [cardId]: true/false }

    // n·∫øu ch∆∞a c√≥ card l·∫ßn ƒë·∫ßu, ƒë·ªÉ tr·ªëng (user ch·ªß ƒë·ªông import)
    // (b·∫°n c√≥ th·ªÉ ƒë·ªïi th√†nh auto import n·∫øu mu·ªën)

    let filtered = [];
    let idx = 0;
    let isFlip = false;

    const $ = (id)=>document.getElementById(id);

    const cardEl = $("card");
    const frontText = $("frontText");
    const backText  = $("backText");
    const backKana  = $("backKana");
    const backVn    = $("backVn");
    const example   = $("example");
    const tagDeck   = $("tagDeck");
    const tagCat    = $("tagCat");
    const tagLevel  = $("tagLevel");
    const stats     = $("stats");
    const listEl    = $("list");
    const modeEl    = $("mode");
    const deckStatsWrap = $("deckStatsWrap");

    const deckFilterEl = $("deckFilter");
    const deckSelectEl = $("deckSelect");

    // ========= Helpers =========
    function deckNameById(id){
      return (decks.find(d=>d.id===id)?.name) || "M·∫∑c ƒë·ªãnh";
    }
    function getDeckStats(){
  // b·ªè deck "all"
  const realDecks = decks.filter(d=>d.id!=="all");
  const stats = realDecks.map(d=>{
    const deckCards = cards.filter(c=>(c.deckId||"default")===d.id);
    const total = deckCards.length;
    const known = deckCards.filter(c=>progress[c.id]===true).length;
    const pct = total ? Math.round((known/total)*100) : 0;
    return { id:d.id, name:d.name, total, known, pct };
  });
  // s·∫Øp x·∫øp: % gi·∫£m d·∫ßn, r·ªìi total gi·∫£m d·∫ßn
  stats.sort((a,b)=> (b.pct-a.pct) || (b.total-a.total));
  return stats;
}

function renderDeckStats(){
  if(!deckStatsWrap) return;

  const s = getDeckStats();
  if(s.length === 0){
    deckStatsWrap.innerHTML = `<div class="hint">Ch∆∞a c√≥ deck.</div>`;
    return;
  }

  const rows = s.map(x=>{
    const lock = (x.id==="default"); // kh√¥ng cho x√≥a deck m·∫∑c ƒë·ªãnh
    return `
      <tr>
        <td style="width:34%">
          <div style="font-weight:800">${x.name}</div>
          <div class="sub"><span class="pill">id: ${x.id}</span></div>
        </td>
        <td style="width:22%">
          <div><b>${x.known}</b> / <b>${x.total}</b></div>
          <div class="sub">ƒë√£ nh·ªõ / t·ªïng</div>
        </td>
        <td style="width:14%">
          <div class="pct">${x.pct}%</div>
        </td>
        <td style="width:30%">
          <div class="rowBtns">
            <button data-studydeck="${x.id}">H·ªçc deck</button>
            <button data-renamedeck="${x.id}">ƒê·ªïi t√™n</button>
            <button data-deletedeck="${x.id}" class="bad" ${lock ? "disabled" : ""}>X√≥a</button>
          </div>
        </td>
      </tr>
    `;
  }).join("");

  deckStatsWrap.innerHTML = `
    <table class="table">
      <thead>
        <tr>
          <th>Deck</th>
          <th>Ti·∫øn ƒë·ªô</th>
          <th>%</th>
          <th style="text-align:right">H√†nh ƒë·ªông</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  `;

  // bind actions
  deckStatsWrap.querySelectorAll("button[data-studydeck]").forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.dataset.studydeck;
      deckFilterEl.value = id;   // l·ªçc sang deck ƒë√≥
      modeEl.value = "all";
      applyFilter();
      window.scrollTo({top:0, behavior:"smooth"});
    };
  });

  deckStatsWrap.querySelectorAll("button[data-renamedeck]").forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.dataset.renamedeck;
      const old = deckNameById(id);
      const name = prompt("T√™n m·ªõi cho deck:", old);
      if(!name) return;

      if(decks.some(d=>d.name.toLowerCase()===name.trim().toLowerCase() && d.id!==id)){
        alert("T√™n deck b·ªã tr√πng.");
        return;
      }

      decks = decks.map(d=> d.id===id ? {...d, name:name.trim()} : d);
      saveJSON(KEY_DECKS, decks);
      renderDeckOptions();
      renderDeckStats();
      applyFilter();
    };
  });

  deckStatsWrap.querySelectorAll("button[data-deletedeck]").forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.dataset.deletedeck;
      if(id==="default") return;

      const name = deckNameById(id);
      if(!confirm(`X√≥a deck "${name}"?\n(Th·∫ª trong deck s·∫Ω chuy·ªÉn v·ªÅ 'M·∫∑c ƒë·ªãnh')`)) return;

      cards = cards.map(c => (c.deckId===id ? {...c, deckId:"default"} : c));
      decks = decks.filter(d=>d.id!==id);

      saveJSON(KEY_CARDS, cards);
      saveJSON(KEY_DECKS, decks);

      renderDeckOptions();
      renderDeckStats();
      deckFilterEl.value = "all";
      applyFilter();
    };
  });
}
    function renderDeckOptions(){
      // deckFilter: c√≥ "all"
      deckFilterEl.innerHTML = "";
      decks.forEach(d=>{
        const opt = document.createElement("option");
        opt.value = d.id;
        opt.textContent = d.name;
        deckFilterEl.appendChild(opt);
      });

      // deckSelect: kh√¥ng cho ch·ªçn "all"
      deckSelectEl.innerHTML = "";
      decks.filter(d=>d.id!=="all").forEach(d=>{
        const opt = document.createElement("option");
        opt.value = d.id;
        opt.textContent = d.name;
        deckSelectEl.appendChild(opt);
      });

      // ch·ªçn m·∫∑c ƒë·ªãnh
      if(!deckFilterEl.value) deckFilterEl.value = "all";
      if(!deckSelectEl.value) deckSelectEl.value = "default";
    }

    function applyFilter(){
      const mode = modeEl.value;
      const deckId = deckFilterEl.value;

      let arr = cards.slice();

      if(deckId !== "all"){
        arr = arr.filter(c => (c.deckId || "default") === deckId);
      }

      if(mode === "new"){
        arr = arr.filter(c => progress[c.id] !== true);
      } else if(mode === "known"){
        arr = arr.filter(c => progress[c.id] === true);
      }

      filtered = arr;

      if(filtered.length === 0){
        idx = 0;
        renderEmpty();
        renderStats();
        renderList();
        return;
      }

      idx = Math.min(idx, filtered.length - 1);
      isFlip = false;
      cardEl.classList.remove("flip");
      renderCard();
      renderStats();
      renderList();
    }

    function renderEmpty(){
      frontText.textContent = "Ch∆∞a c√≥ th·∫ª";
      $("frontSub").textContent = "H√£y th√™m th·∫ª ho·∫∑c Import m·∫´u";
      backText.textContent = "‚Äî";
      backKana.textContent = "‚Äî";
      backVn.textContent = "‚Äî";
      example.textContent = "V√≠ d·ª•: ‚Äî";
      tagDeck.textContent = "üìö Deck: ‚Äî";
      tagCat.textContent = "#";
      tagLevel.textContent = "N?";
    }

    function renderCard(){
      if(filtered.length === 0) return;

      const c = filtered[idx];
      const known = progress[c.id] === true;

      frontText.textContent = c.jp || "‚Äî";
      $("frontSub").textContent = known ? "‚úÖ ƒê√£ nh·ªõ" : "üü° Ch∆∞a nh·ªõ";

      backText.textContent = c.jp || "‚Äî";
      backKana.textContent = c.kana ? `(${c.kana})` : "‚Äî";
      backVn.textContent = c.vn || "‚Äî";
      example.textContent = "V√≠ d·ª•: " + (c.ex || "‚Äî");

      tagDeck.textContent = "üìö Deck: " + deckNameById(c.deckId || "default");
      tagCat.textContent = "#" + (c.cat || "kh√°c");
      tagLevel.textContent = (c.level || "N?");
    }

    function renderStats(){
      const total = cards.length;

      // known/unknown theo T·∫§T C·∫¢ cards
      const knownAll = Object.values(progress).filter(v=>v===true).length;

      // trong filter hi·ªán t·∫°i
      const showing = filtered.length;
      const knownShowing = filtered.filter(c=>progress[c.id]===true).length;

      stats.innerHTML = `
        <div>üì¶ T·ªïng th·∫ª: <b>${total}</b></div>
        <div>‚úÖ ƒê√£ nh·ªõ (t·ªïng): <b>${knownAll}</b></div>
        <div>üîé Hi·ªÉn th·ªã: <b>${showing}</b></div>
        <div>‚úÖ ƒê√£ nh·ªõ (hi·ªÉn th·ªã): <b>${knownShowing}</b></div>
        <div>üß≠ V·ªã tr√≠: <b>${showing ? (idx+1) : 0}/${showing}</b></div>
      `;
    }

    function renderList(){
      listEl.innerHTML = "";
      if(cards.length === 0){
        listEl.innerHTML = `<div class="hint">Ch∆∞a c√≥ d·ªØ li·ªáu. B·∫•m <b>Import m·∫´u</b> ho·∫∑c th√™m th·∫ª m·ªõi.</div>`;
        return;
      }

      // list hi·ªÉn th·ªã theo deckFilter ƒë·ªÉ ƒë·ª° r·ªëi
      const deckId = deckFilterEl.value;
      const listCards = (deckId==="all") ? cards : cards.filter(c=>(c.deckId||"default")===deckId);

      listCards.forEach((c)=>{
        const div = document.createElement("div");
        div.className = "item";
        const known = progress[c.id] === true;

        div.innerHTML = `
          <div>
            <div style="font-weight:700">${c.jp || "‚Äî"} <small>${c.kana ? "("+c.kana+")" : ""}</small></div>
            <div class="sub">${c.vn || ""}</div>
            <div class="sub">üìö ${deckNameById(c.deckId || "default")} ${(c.cat? " ‚Ä¢ #"+c.cat : "")} ${c.level ? " ‚Ä¢ "+c.level : ""} ${known ? " ‚Ä¢ ‚úÖ ƒë√£ nh·ªõ" : ""}</div>
          </div>
          <div class="itemBtns">
            <button data-go="${c.id}">H·ªçc</button>
            <button data-del="${c.id}" class="bad">X√≥a</button>
          </div>
        `;
        listEl.appendChild(div);
      });

      listEl.querySelectorAll("button[data-go]").forEach(btn=>{
        btn.onclick = ()=>{
          const id = btn.dataset.go;
          const pos = filtered.findIndex(x=>x.id===id);
          if(pos >= 0){
            idx = pos;
            isFlip = false;
            cardEl.classList.remove("flip");
            renderCard(); renderStats();
          } else {
            // n·∫øu kh√¥ng n·∫±m trong filtered (do mode filter), chuy·ªÉn mode=all v√† th·ª≠ l·∫°i
            modeEl.value = "all";
            applyFilter();
            const pos2 = filtered.findIndex(x=>x.id===id);
            if(pos2 >= 0){
              idx = pos2;
              renderCard(); renderStats();
            }
          }
        };
      });

      listEl.querySelectorAll("button[data-del]").forEach(btn=>{
        btn.onclick = ()=>{
          const id = btn.dataset.del;
          if(!confirm("X√≥a th·∫ª n√†y?")) return;
          cards = cards.filter(c=>c.id!==id);
          delete progress[id];
          saveJSON(KEY_CARDS, cards);
          saveJSON(KEY_PROGRESS, progress);
          applyFilter();
        };
      });
    }

    function next(){
      if(filtered.length === 0) return;
      idx = (idx + 1) % filtered.length;
      isFlip = false;
      cardEl.classList.remove("flip");
      renderCard(); renderStats();
    }
    function prev(){
      if(filtered.length === 0) return;
      idx = (idx - 1 + filtered.length) % filtered.length;
      isFlip = false;
      cardEl.classList.remove("flip");
      renderCard(); renderStats();
    }
    function flip(){
      if(filtered.length === 0) return;
      isFlip = !isFlip;
      cardEl.classList.toggle("flip", isFlip);
    }
    function markKnown(val){
      if(filtered.length === 0) return;
      const c = filtered[idx];
      progress[c.id] = val;
      saveJSON(KEY_PROGRESS, progress);
      renderCard(); renderStats(); renderList();
      if(modeEl.value !== "all") applyFilter();
    }

    // ========= Deck actions =========
    $("createDeckBtn").onclick = ()=>{
      const name = $("newDeckName").value.trim();
      if(!name){ alert("Nh·∫≠p t√™n deck tr∆∞·ªõc nh√©."); return; }
      // ch·ªëng tr√πng t√™n
      if(decks.some(d=>d.name.toLowerCase()===name.toLowerCase())){
        alert("Deck n√†y ƒë√£ t·ªìn t·∫°i.");
        return;
      }
      const id = uid();
      decks.push({id, name});
      saveJSON(KEY_DECKS, decks);
      $("newDeckName").value = "";
      renderDeckOptions();
      deckFilterEl.value = id; // chuy·ªÉn sang deck m·ªõi
      deckSelectEl.value = id;
      applyFilter();
    };

    $("deleteDeckBtn").onclick = ()=>{
      const id = deckFilterEl.value;
      if(id === "all"){ alert("Kh√¥ng th·ªÉ x√≥a 'T·∫•t c·∫£ (All)'."); return; }
      if(id === "default"){ alert("Kh√¥ng th·ªÉ x√≥a deck 'M·∫∑c ƒë·ªãnh'."); return; }
      const name = deckNameById(id);
      if(!confirm(`X√≥a deck "${name}"?\n(Th·∫ª trong deck s·∫Ω chuy·ªÉn v·ªÅ 'M·∫∑c ƒë·ªãnh')`)) return;

      // chuy·ªÉn th·∫ª v·ªÅ default
      cards = cards.map(c => (c.deckId===id ? {...c, deckId:"default"} : c));
      decks = decks.filter(d=>d.id!==id);

      saveJSON(KEY_CARDS, cards);
      saveJSON(KEY_DECKS, decks);

      renderDeckOptions();
      deckFilterEl.value = "all";
      applyFilter();
    };

    // ========= Buttons =========
    $("nextBtn").onclick = next;
    $("prevBtn").onclick = prev;
    $("flipBtn").onclick = flip;
    cardEl.onclick = flip;

    $("markKnown").onclick = ()=>markKnown(true);
    $("markUnknown").onclick = ()=>markKnown(false);

    $("shuffleBtn").onclick = ()=>{
      for(let i=filtered.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [filtered[i], filtered[j]] = [filtered[j], filtered[i]];
      }
      idx = 0;
      isFlip = false;
      cardEl.classList.remove("flip");
      renderCard(); renderStats();
    };

    $("resetProgress").onclick = ()=>{
      progress = {};
      saveJSON(KEY_PROGRESS, progress);
      applyFilter();
    };

    $("addBtn").onclick = ()=>{
      const c = {
        id: uid(),
        deckId: deckSelectEl.value || "default",
        jp: $("jp").value.trim(),
        kana: $("kana").value.trim(),
        vn: $("vn").value.trim(),
        ex: $("ex").value.trim(),
        cat: $("cat").value.trim(),
        level: $("level").value.trim(),
      };
      if(!c.jp || !c.vn){
        alert("H√£y nh·∫≠p √≠t nh·∫•t: Êó•Êú¨Ë™û v√† Nghƒ©a ti·∫øng Vi·ªát.");
        return;
      }
      cards.unshift(c);
      saveJSON(KEY_CARDS, cards);

      ["jp","kana","vn","ex","cat","level"].forEach(id=>$(id).value="");
      applyFilter();
    };

    $("importBtn").onclick = ()=>{
      if(cards.length && !confirm("Th√™m b·ªô m·∫´u v√†o danh s√°ch hi·ªán t·∫°i?")) return;

      // ƒë·∫£m b·∫£o c√°c card m·∫´u c√≥ id
      const samples = defaultCards.map(x => ({...x, id: uid()}));
      cards = [...samples, ...cards];
      saveJSON(KEY_CARDS, cards);
      applyFilter();
    };

    $("clearAllBtn").onclick = ()=>{
      if(!confirm("X√≥a to√†n b·ªô th·∫ª, deck v√† ti·∫øn ƒë·ªô?")) return;
      cards = [];
      progress = {};
      decks = [{ id:"all", name:"T·∫•t c·∫£ (All)" }, { id:"default", name:"M·∫∑c ƒë·ªãnh" }];

      localStorage.removeItem(KEY_CARDS);
      localStorage.removeItem(KEY_PROGRESS);
      saveJSON(KEY_DECKS, decks);

      renderDeckOptions();
      applyFilter();
    };

    modeEl.onchange = applyFilter;
    deckFilterEl.onchange = applyFilter;

    // Keyboard
    window.addEventListener("keydown", (e)=>{
      if(e.key === "ArrowRight") next();
      if(e.key === "ArrowLeft") prev();
      if(e.key === " "){ e.preventDefault(); flip(); }
      if(e.key.toLowerCase() === "k") markKnown(true);
      if(e.key.toLowerCase() === "u") markKnown(false);
    });

    // Init
    renderDeckOptions();
renderDeckStats();
applyFilter();
    if(cards.length === 0) renderEmpty();
  </script>
</body>
</html>
